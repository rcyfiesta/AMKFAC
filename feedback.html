<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trainer Feedback</title>
    <link rel="icon" href="data:,"> <!-- prevents favicon 404 -->
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
    </style>
</head>

<body>

<h1>Trainer Feedback</h1>

<div id="feedbackContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBvJpARNfHPu8j8E99_3CIsNbSBVzBCFQA",
  authDomain: "amkfac-c85a0.firebaseapp.com",
  projectId: "amkfac-c85a0",
  storageBucket: "amkfac-c85a0.firebasestorage.app",
  messagingSenderId: "320355813529",
  appId: "1:320355813529:web:a2e979ad989f95acbb5008"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const feedbackContainer = document.getElementById("feedbackContainer");

const q = query(collection(db, "scenarios"));

onSnapshot(q, snapshot => {

    if (!feedbackContainer) return;

    feedbackContainer.innerHTML = "";

    const grouped = {};

    // GROUP DATA
    snapshot.forEach(docSnap => {

        const data = docSnap.data();

        if (!data.feedback && !data.rubric) return;

        const scenario = data.scenarioNumber;
        const casualty = data.casualtyNumber;

        if (!grouped[scenario]) grouped[scenario] = {};
        if (!grouped[scenario][casualty]) {
            grouped[scenario][casualty] = { injuries: {} };
        }

        const injuries = data.injuries || [];

        injuries.forEach(injury => {
            grouped[scenario][casualty].injuries[injury] = {
                feedback: data.feedback?.[injury] || "",
                rubric: data.rubric?.[injury] || []
            };
        });
    });

    // RENDER STRUCTURE
    Object.keys(grouped).sort().forEach(scenario => {

        const scenarioDiv = document.createElement("div");
        scenarioDiv.style.border = "3px solid black";
        scenarioDiv.style.padding = "15px";
        scenarioDiv.style.marginBottom = "20px";

        const scenarioHeader = document.createElement("h2");
        scenarioHeader.textContent = "Scenario " + scenario;
        scenarioDiv.appendChild(scenarioHeader);

        Object.keys(grouped[scenario]).sort().forEach(casualty => {

            const casualtyDiv = document.createElement("div");
            casualtyDiv.style.border = "2px solid #555";
            casualtyDiv.style.padding = "10px";
            casualtyDiv.style.marginBottom = "15px";

            const casualtyHeader = document.createElement("h3");
            casualtyHeader.textContent = "Casualty " + casualty;
            casualtyDiv.appendChild(casualtyHeader);

            const injuryData = grouped[scenario][casualty].injuries;

            Object.keys(injuryData).forEach(injury => {

                const injuryDiv = document.createElement("div");
                injuryDiv.style.border = "1px solid #ccc";
                injuryDiv.style.padding = "8px";
                injuryDiv.style.marginBottom = "10px";

                injuryDiv.innerHTML = `<strong>Injury:</strong> ${injury}`;

                // Feedback
                if (injuryData[injury].feedback) {
                    const fb = document.createElement("p");
                    fb.innerHTML = `<strong>Feedback:</strong> ${injuryData[injury].feedback}`;
                    injuryDiv.appendChild(fb);
                }

                // Unticked rubric
                const unticked = injuryData[injury].rubric.filter(r => !r.checked);

                if (unticked.length > 0) {
                    const rubricHeader = document.createElement("p");
                    rubricHeader.innerHTML = "<strong>Unticked Criteria:</strong>";
                    injuryDiv.appendChild(rubricHeader);

                    const ul = document.createElement("ul");

                    unticked.forEach(item => {
                        const li = document.createElement("li");
                        li.textContent = item.criteria;
                        ul.appendChild(li);
                    });

                    injuryDiv.appendChild(ul);
                }

                casualtyDiv.appendChild(injuryDiv);
            });

            scenarioDiv.appendChild(casualtyDiv);
        });

        feedbackContainer.appendChild(scenarioDiv);
    });

});
</script>

</body>
</html>