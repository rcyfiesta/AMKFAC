<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trainer Interface</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<h1>Trainer Interface</h1>

<label>Scenario</label>
<select id="scenarioSelect"></select>

<label>Casualty</label>
<select id="casualtySelect"></select>

<hr>

<h2>Casualty Information</h2>

<p>
  <strong>Scenario:</strong> 
  <span id="displayScenario"></span>
</p>

<p>
  <strong>Casualty:</strong> 
  <span id="displayCasualty"></span>
  <button id="revealNameBtn" style="margin-left:10px; background-color:#007bff; color:white;">
    Show Name To Casualty
  </button>
</p>

<div id="infoSection"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, query, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBvJpARNfHPu8j8E99_3CIsNbSBVzBCFQA",
  authDomain: "amkfac-c85a0.firebaseapp.com",
  projectId: "amkfac-c85a0",
  storageBucket: "amkfac-c85a0.firebasestorage.app",
  messagingSenderId: "320355813529",
  appId: "1:320355813529:web:a2e979ad989f95acbb5008"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const scenarioSelect = document.getElementById("scenarioSelect");
const casualtySelect = document.getElementById("casualtySelect");
const displayScenario = document.getElementById("displayScenario");
const displayCasualty = document.getElementById("displayCasualty");
const revealNameBtn = document.getElementById("revealNameBtn");

revealNameBtn.addEventListener("click", async () => {

    if (!currentDocId) {
        alert("Please select a scenario and casualty first.");
        return;
    }

    await updateDoc(doc(db, "scenarios", currentDocId), {
        "visibility.casualtyName": true
    });

    alert("Casualty name revealed to casualty.");
});
const infoSection = document.getElementById("infoSection");

let allScenarios = [];
let currentDocId = null;

// Injury images
const injuryImages = {
  abrasion: "images/abrasion.png",
  "allergic reaction (severe)": "images/allergic.png",
  amputation: "images/amputation.png",
  avulsion: "images/avulsion.png",
  "bee sting": "images/bee.png",
  "closed fracture": "images/closed.png",
  "dislocation": "images/closed.png",
  contusion: "images/contusion.png",
  "heat exhaustion": "images/exhaustion.png",
  "1st degree burn": "images/first.png",
  incision: "images/incision.png",
  laceration: "images/laceration.png",
  "abdominal thrust": "images/not.png",
  "choking (unconscious)": "images/not.png",
  "open fracture": "images/open.png",
  "penetrating object": "images/penetrating.png",
  "chest thrust": "images/pregnant.png",
  "puncture wound": "images/puncture.png",
  "2nd degree burn": "images/second.png",
  shock: "images/shock.png",
  "snake bite": "images/snake.png",
  sprain: "images/sprain.png",
  strain: "images/strain.png",
  "3rd degree burn": "images/third.png",
  "scorpion sting": "images/scorpion.png",
  "jellyfish sting": "images/jellyfish.png",
  "animal bite": "images/animal.png",
  "electrical burn": "images/electrical.png",
  "epistaxis (nose bleed)": "images/nose.png",
};

// Rubric
const injuryRubric = {
concussion: [
  "Call SCDF 995",
  "Start DRSABC",
  "If fluid coming out of nose/ears, turn the casualty head so that affected nostril/ear lower than the unaffected one",
  "Check breathing and consciousness every 2 minutes"
],

compression: [
  "Call SCDF 995",
  "Start DRSABC",
  "If fluid coming out of nose/ears, turn the casualty head so that affected nostril/ear lower than the unaffected one",
  "Check breathing and consciousness every 2 minutes"
],

"skull fracture": [
  "Call SCDF 995",
  "Start DRSABC",
  "If fluid coming out of nose/ears, turn the casualty head so that affected nostril/ear lower than the unaffected one",
  "Check breathing and consciousness every 2 minutes"
],

"spinal injury": [
  "Call SCDF 995",
  "Tell casualty don't move head",
  "Place items around head to immobilise it"
],

"heat cramp": [
  "Stop activity and move to cool place",
  "Encourage drink water/isotonic drink",
  "Stretch the affected limb",
  "Rest for at least 2 hours"
],

"heat exhaustion": [
  "Move to cool place",
  "Loosen clothing",
  "Fan/cool the casualty",
  "Encourage drink water/isotonic drink",
  "Check breathing and consciousness every 2 minutes"
],

"heat stroke": [
  "Call SCDF 995",
  "Move to cool place",
  "Start DRSABC",
  "Place ice pack (not directly on skin) at neck, under armpit, at groin",
  "Check breathing and consciousness every 2 minutes",
  "Recovery position"
],

fits: [
  "Lower casualty carefully to lie down",
  "Protect the head",
  "Time the seizure (if >5 mins, call SCDF 995)",
  "Place in recovery position after seizure stops",
  "Do not restrain or hold the casualty",
  "Do not insert anything into the mouth"
],

fainting: [
  "Lay casualty on the floor",
  "Elevate legs (IF NOT FRACTURES)",
  "Loosen clothing",
  "Check breathing and consciousness every 2 minutes"
],

shock: [
  "DRSABC",
  "Call SCDF 995",
  "Elevate legs",
  "Cover the casualty with blanket",
  "Treat the severe bleeding"
],

"hypoglycaemia/low blood sugar": [
  "Give sweet drink if casualty can drink",
  "DRSABC if casualty turns unconscious",
  "Check breathing and consciousness every 2 minutes"
],

stroke: [
  "Face weakness: Ask casualty to smile",
  "Arm weakness: Ask casualty to raise both arms",
  "Speech slurring: Ask casualty for name",
  "Time to call SCDF 995",
  "Recovery position",
  "DRSABC if casualty turns unconscious"
],

"abdominal thrust": [
  "Casualty unable to speak, breathe, cough, universal sign of choking",
  "\"Are you choking?\"",
  "\"Are you able to cough?\"",
  "\"I am a first aider, I can help you\"",
  "Locate belly button using ring finger",
  "Place middle and index finger above ring finger",
  "Form a fist with thumb inside",
  "Place fist above index finger (thumb side facing casualty)",
  "Lean casualty forward",
  "Cup the fist with other hand",
  "Do inward and upward thrust",
  "Repeat until foreign body comes out OR casualty turns unconscious"
],

"chest thrust": [
  "Casualty unable to speak, breathe, cough, universal sign of choking",
  "\"Are you choking?\"",
  "\"Are you able to cough?\"",
  "\"I am a first aider, I can help you\"",
  "2 arms straightened at casualty's armpit",
  "Lift casualty's arm upwards",
  "Form a fist with thumb inside",
  "Place fist at centre of chest (thumb side facing casualty)",
  "Cup the fist with other hand",
  "Do backwards thrust",
  "Repeat until foreign body comes out OR casualty turns unconscious"
],

"choking (unconscious)": [
  "Call SCDF 995",
  "Shout for ATL to get AED",
  "Start 30 chest compressions",
  "Check for foreign body",
  "If no foreign body seen, repeat 30 chest compressions then check again",
  "If foreign body seen, open mouth and use index finger to scoop out",
  "After foreign body is out, check breathing",
  "Recovery position after breathing returns",
  "Monitor breathing and consciousness every 2 minutes"
],

asthma: [
  "\"Are you having an asthma attack?\"",
  "\"I'm a first aider, I can help you\"",
  "\"Do you have your inhaler?\"",
  "\"Do you need assistance with your inhaler?\"",
  "Shake inhaler 3 - 5 seconds",
  "Give 1 puff, casualty breathes normally for 1 minute",
  "If still attack, repeat from shaking inhaler",
  "After 4 puffs, if still attack, call SCDF 995"
],

hyperventilation: [
  "Reassure casualty",
  "Bring casualty to quiet place",
  "\"Breathe innnnn, breathe outtt\" (guide slow breathing)"
],

"allergic reaction (severe)": [
  "Call SCDF 995",
  "\"Are you having an allergic reaction?\"",
  "\"I am a first aider, I can help you\"",
  "\"Do you have any medication with you?\"",
  "Remove the blue safety cap",
  "Position orange part at 90Â° to the outer mid thigh",
  "Swing and jab into thigh, hold for 10 seconds",
  "Remove EpiPen and massage area for 10 seconds",
  "Monitor breathing and consciousness every 2 minutes"
],

contusion: [
  "Rest and ice area for 10 - 15 minutes"
],

abrasion: [
  "Pour saline water on abrasion",
  "Clean using gauze in ONE circular motion from INNER to OUTER of wound",
  "Dry the wound with gauze",
  "Clean using at least 3 gauze"
],

incision: [
  "Use gauze/pressure pad to cover injury",
  "Bandage to secure and apply pressure to reduce bleeding"
],

laceration: [
  "Use gauze/pressure pad to cover injury",
  "Bandage to secure and apply pressure to reduce bleeding"
],

avulsion: [
  "Call SCDF 995",
  "Use gauze/pressure pad to cover injury",
  "Bandage to secure and apply pressure",
  "Take any detached skin to hospital"
],

"penetrating object": [
  "Call SCDF 995",
  "Secure embedded object using 2 triangular bandages",
  "Bandage area to immobilise object"
],

amputation: [
  "Call SCDF 995",
  "Use pressure pad to apply direct pressure",
  "Apply tourniquet",
  "Record time applied and inform paramedics",
  "Treat for shock",
  "Wrap amputated part in clean dry gauze",
  "Place in small bag",
  "Place small bag in another bag/container filled with ice",
  "Label bag with casualty name and time found"
],

"bee sting": [
  "Flick stinger out using card OR pull with tweezers",
  "Ice area 10 - 15 minutes",
  "Monitor for allergic reaction, breathing and consciousness",
  "See doctor if pain/swelling persists"
],

"scorpion sting": [
  "Call SCDF 995",
  "Keep area lower than heart level",
  "Ice area 10 - 15 minutes",
  "Monitor breathing and consciousness"
],

"snake bite": [
  "Call SCDF 995 and give description of snake",
  "Keep area lower than heart level",
  "Apply tight bandage 4 finger space above wound",
  "Immobilise limb",
  "Check breathing and consciousness every 2 minutes"
],

"jellyfish sting": [
  "Call SCDF 995",
  "Pour large amount of vinegar or seawater",
  "Immerse in warm water",
  "Monitor breathing and consciousness every 2 minutes"
],

"animal bite": [
  "Call SCDF 995",
  "Wash under running water until clean",
  "Bandage after cleaning"
],

strain: [
  "Rest area",
  "Ice 10 - 15 minutes (no direct contact)",
  "Compress with bandage",
  "Elevate area"
],

sprain: [
  "Remove footwear if any",
  "Rest area",
  "Ice 10 - 15 minutes (no direct contact)",
  "Compress with bandage",
  "Elevate area"
],

"muscle cramp": [
  "Stretch the area"
],

"1st degree burn": [
  "Remove constrictors",
  "Cool under running water for at least 10 minutes",
  "Cover with bandage",
  "Consult doctor"
],

"2nd degree burn": [
  "Remove constrictors",
  "Cool under running water for at least 10 minutes",
  "Cover with bandage",
  "Consult doctor"
],

"3rd degree burn": [
  "Call SCDF 995",
  "Cover with bandage",
  "Treat for shock if needed"
],

"chemical burn": [
  "Call SCDF 995 and inform chemicals involved",
  "Remove contaminated clothing",
  "Cool under running water for 15 - 20 minutes"
],

"electrical burn": [
  "Call SCDF 995",
  "Move source of danger away (do NOT use hands)",
  "Treat for shock",
  "Cover wounds",
  "Monitor breathing and consciousness every 2 minutes"
],

"sun burn": [
  "Move to cool shaded area",
  "Cover affected areas with clothing",
  "Give water",
  "Dab water on affected areas"
],

"epistaxis (nose bleed)": [
  "Sit casualty up",
  "Pinch fleshy part of nose for 10 minutes",
  "Lean forward",
  "Breathe through mouth",
  "If bleeding >1 hour, consult doctor"
]
};

// Load scenarios
const q = query(collection(db, "scenarios"));
onSnapshot(q, snapshot => {
    allScenarios = [];
    snapshot.forEach(docSnap => allScenarios.push({ id: docSnap.id, ...docSnap.data() }));

    const scenarios = [...new Set(allScenarios.map(s => s.scenarioNumber))];
    scenarioSelect.innerHTML = "<option value=''>Select Scenario</option>";
    scenarios.forEach(s => scenarioSelect.appendChild(new Option(s, s)));
});

// Update casualty dropdown
scenarioSelect.addEventListener("change", () => {
    const selected = scenarioSelect.value;

    const casualties = allScenarios
        .filter(s => s.scenarioNumber === selected)
        .map(s => s.casualtyNumber);

    casualtySelect.innerHTML = "<option value=''>Select Casualty</option>";

    [...new Set(casualties)].forEach(num => {
        casualtySelect.appendChild(new Option("Casualty " + num, num));
    });
});

// Show casualty info
casualtySelect.addEventListener("change", () => {
    const scenario = scenarioSelect.value;
    const casualty = casualtySelect.value;

    const match = allScenarios.find(
        s => s.scenarioNumber === scenario && s.casualtyNumber === casualty
    );

    if (!match) return;

    currentDocId = match.id;
    displayScenario.textContent = match.scenarioNumber;
    displayCasualty.textContent = match.casualtyName;

    renderInfo(match);
});

function renderInfo(data) {
    infoSection.innerHTML = "";

    const injuryDiv = document.createElement("div");
    injuryDiv.innerHTML = "<h3>Injuries</h3>";

    data.injuries.forEach(injuryObj => {

        const injury = injuryObj.type;
        const lower = injury.toLowerCase();
        const container = document.createElement("div");
        container.style.border = "1px solid #ccc";
        container.style.padding = "10px";
        container.style.marginBottom = "10px";
        const side = injuryObj.side === "NA" ? "" : injuryObj.side;
        const site = injuryObj.site === "NA" ? "" : injuryObj.site;
        const locationText = `${side} ${site}`.trim();
        container.innerHTML += `
            <h4>${injury}</h4>
            ${locationText ? `<p><strong>Location:</strong> ${locationText}</p>` : ""}
`;

        // Image
        if (injuryImages[lower]) {
            const img = document.createElement("img");
            img.src = injuryImages[lower];
            img.style.width = "150px";
            img.onerror = function(){ this.style.display = "none"; };
            container.appendChild(img);
        }

        // Rubric
        const rubricStates = [];
        if (injuryRubric[lower]) {
            injuryRubric[lower].forEach(criteria => {
                const label = document.createElement("label");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.style.marginRight = "5px";
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(criteria));
                container.appendChild(label);
                container.appendChild(document.createElement("br"));

                rubricStates.push({ criteria, checkbox });
            });
        }

        // Feedback
        const feedback = document.createElement("textarea");
        feedback.placeholder = "Trainer feedback for this injury";
        feedback.style.display = "block";
        feedback.style.marginTop = "5px";
        container.appendChild(feedback);

        const saveBtn = document.createElement("button");
        saveBtn.textContent = "Submit Feedback";
        saveBtn.style.marginTop = "5px";

        saveBtn.onclick = async () => {
            const rubricData = rubricStates.map(item => ({
                criteria: item.criteria,
                checked: item.checkbox.checked
            }));

            await updateDoc(doc(db, "scenarios", currentDocId), {
                [`feedback.${injury}`]: feedback.value,
                [`rubric.${injury}`]: rubricData
            });

            alert(`Feedback for ${injury} submitted.`);
        };

        container.appendChild(saveBtn);
        injuryDiv.appendChild(container);
    });


    // Reveal injuries button
    const revealBtn = document.createElement("button");
    revealBtn.textContent = "Show Injuries To Casualty";
    revealBtn.style.marginTop = "10px";
    revealBtn.style.backgroundColor = "#28a745";
    revealBtn.style.color = "white";

    revealBtn.onclick = async () => {
        await updateDoc(doc(db, "scenarios", currentDocId), {
            "visibility.injuries": true
        });
        alert("Injuries revealed to casualty.");
    };

    injuryDiv.appendChild(revealBtn);

    infoSection.appendChild(injuryDiv);

    addPushSection("What Happened", data.whatHappened, "whatHappened");
    addPushSection("Medical History", data.medicalHistory, "medicalHistory");
    addPushSection("Drug Allergies", data.allergies, "allergies");
    addPushSection("Last Meal", data.lastMeal, "lastMeal");
}

function addPushSection(title, value, field) {
    const div = document.createElement("div");
    div.style.marginTop = "15px";
    div.innerHTML = `<h3>${title}</h3><p>${value}</p>`;

    const btn = document.createElement("button");
    btn.textContent = `Show ${title} To Casualty`;

    btn.onclick = async () => {
        await updateDoc(doc(db, "scenarios", currentDocId), {
            [`visibility.${field}`]: true
        });
        alert(title + " revealed.");
    };

    div.appendChild(btn);
    infoSection.appendChild(div);
}
</script>
</body>
</html>