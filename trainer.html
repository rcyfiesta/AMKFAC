<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trainer Interface</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<h1>Trainer Interface</h1>

<label>Scenario</label>
<select id="scenarioSelect"></select>

<label>Casualty</label>
<select id="casualtySelect"></select>

<hr>

<h2>Casualty Information</h2>
<p><strong>Scenario:</strong> <span id="displayScenario"></span></p>
<p><strong>Casualty:</strong> <span id="displayCasualty"></span></p>

<div id="infoSection"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, query, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "amkfac-c85a0.firebaseapp.com",
  projectId: "amkfac-c85a0",
  storageBucket: "amkfac-c85a0.firebasestorage.app",
  messagingSenderId: "320355813529",
  appId: "1:320355813529:web:a2e979ad989f95acbb5008"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const scenarioSelect = document.getElementById("scenarioSelect");
const casualtySelect = document.getElementById("casualtySelect");
const displayScenario = document.getElementById("displayScenario");
const displayCasualty = document.getElementById("displayCasualty");
const infoSection = document.getElementById("infoSection");

let allScenarios = [];
let currentDocId = null;

// Injury images
const injuryImages = {
  abrasion: "images/abrasion.png",
  allergic: "images/allergic.png",
  amputation: "images/amputation.png",
  avulsion: "images/avulsion.png",
  bee: "images/bee.png",
  closed: "images/closed.png",
  contusion: "images/contusion.png",
  exhaustion: "images/exhaustion.png",
  first: "images/first.png",
  incision: "images/incision.png",
  laceration: "images/laceration.png",
  not: "images/not.png",
  open: "images/open.png",
  penetrating: "images/penetrating.png",
  pregnant: "images/pregnant.png",
  puncture: "images/puncture.png",
  second: "images/second.png",
  shock: "images/shock.png",
  snake: "images/snake.png",
  sprain: "images/sprain.png",
  strain: "images/strain.png",
  third: "images/third.png",
};

// Load scenarios
const q = query(collection(db, "scenarios"));
onSnapshot(q, snapshot => {
    allScenarios = [];
    snapshot.forEach(docSnap => allScenarios.push({ id: docSnap.id, ...docSnap.data() }));

    const scenarios = [...new Set(allScenarios.map(s => s.scenarioNumber))];
    scenarioSelect.innerHTML = "<option value=''>Select Scenario</option>";
    scenarios.forEach(s => scenarioSelect.appendChild(new Option(s, s)));
});

// Casualty dropdown
scenarioSelect.addEventListener("change", () => {
    const selected = scenarioSelect.value;
    const casualties = allScenarios
        .filter(s => s.scenarioNumber == selected)
        .slice(0,3)
        .map(s => s.casualtyName);
    casualtySelect.innerHTML = "<option value=''>Select Casualty</option>";
    [...new Set(casualties)].forEach(c => casualtySelect.appendChild(new Option(c, c)));
});

// Show casualty info
casualtySelect.addEventListener("change", () => {
    const scenario = scenarioSelect.value;
    const casualty = casualtySelect.value;
    const match = allScenarios.find(s => s.scenarioNumber == scenario && s.casualtyName === casualty);
    if (!match) return;

    currentDocId = match.id;
    displayScenario.textContent = match.scenarioNumber;
    displayCasualty.textContent = match.casualtyName;

    renderInfo(match);
});

function renderInfo(data) {
    infoSection.innerHTML = "";

    const injuryDiv = document.createElement("div");
    injuryDiv.innerHTML = "<h3>Injuries</h3>";

    data.injuries.forEach(injury => {
        const lower = injury.toLowerCase();
        const container = document.createElement("div");
        container.style.border = "1px solid #ccc";
        container.style.padding = "10px";
        container.style.marginBottom = "10px";
        container.innerHTML += `<h4>${injury}</h4>`;

        if (injuryImages[lower]) {
            const img = document.createElement("img");
            img.src = injuryImages[lower];
            img.style.width = "150px";
            img.onerror = function(){ this.style.display = "none"; };
            container.appendChild(img);
        }

        injuryDiv.appendChild(container);
    });

    // Button to reveal injuries
    const revealBtn = document.createElement("button");
    revealBtn.textContent = "Show Injuries To Casualty";
    revealBtn.style.marginTop = "10px";
    revealBtn.style.backgroundColor = "#28a745";
    revealBtn.style.color = "white";
    revealBtn.onclick = async () => {
        await updateDoc(doc(db, "scenarios", currentDocId), { "visibility.injuries": true });
        alert("Injuries revealed to casualty.");
    };
    injuryDiv.appendChild(revealBtn);

    // âœ… Button to reveal casualty name
    const showNameBtn = document.createElement("button");
    showNameBtn.textContent = "Reveal Casualty Name";
    showNameBtn.style.marginLeft = "10px";
    showNameBtn.style.backgroundColor = "#17a2b8";
    showNameBtn.style.color = "white";
    showNameBtn.onclick = async () => {
        await updateDoc(doc(db, "scenarios", currentDocId), { "visibility.casualtyName": true });
        alert("Casualty name revealed.");
    };
    injuryDiv.appendChild(showNameBtn);

    infoSection.appendChild(injuryDiv);
}
</script>
</body>
</html>