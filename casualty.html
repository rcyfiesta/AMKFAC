<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Casualty View</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        #reloadBtn {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #reloadBtn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

<h1>Casualty View</h1>

<button id="reloadBtn">Reload Page</button>

<label>Scenario Number</label>
<select id="scenarioNumberSelect">
    <option value="">-- Loading scenarios --</option>
</select>

<label>Casualty Name</label>
<select id="casualtyNameSelect">
    <option value="">-- Select Scenario First --</option>
</select>

<div id="casualtyInfo">
    <p><strong>Scenario:</strong> <span id="displayScenario"></span></p>
    <p><strong>Casualty:</strong> <span id="displayCasualty"></span></p>
    <div id="displayInjuries"></div>
    <p><strong>What Happened:</strong> <span id="displayWhatHappened"></span></p>
    <p><strong>Medical History:</strong> <span id="displayMedicalHistory"></span></p>
    <p><strong>Drug Allergies:</strong> <span id="displayAllergies"></span></p>
    <p><strong>Last Meal:</strong> <span id="displayLastMeal"></span></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBvJpARNfHPu8j8E99_3CIsNbSBVzBCFQA",
  authDomain: "amkfac-c85a0.firebaseapp.com",
  projectId: "amkfac-c85a0",
  storageBucket: "amkfac-c85a0.firebasestorage.app",
  messagingSenderId: "320355813529",
  appId: "1:320355813529:web:a2e979ad989f95acbb5008"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const scenarioSelect = document.getElementById("scenarioNumberSelect");
const casualtySelect = document.getElementById("casualtyNameSelect");

const displayScenario = document.getElementById("displayScenario");
const displayCasualty = document.getElementById("displayCasualty");
const displayInjuries = document.getElementById("displayInjuries");
const displayWhatHappened = document.getElementById("displayWhatHappened");
const displayMedicalHistory = document.getElementById("displayMedicalHistory");
const displayAllergies = document.getElementById("displayAllergies");
const displayLastMeal = document.getElementById("displayLastMeal");

const reloadBtn = document.getElementById("reloadBtn");

let allScenarios = [];

// Injury image mapping
const injuryImages = {
  abrasion: "images/abrasion.png",
  "allergic reaction (severe)": "images/allergic.png",
  amputation: "images/amputation.png",
  avulsion: "images/avulsion.png",
  "bee sting": "images/bee.png",
  "closed fracture": "images/closed.png",
  "dislocation": "images/closed.png",
  contusion: "images/contusion.png",
  "heat exhaustion": "images/exhaustion.png",
  "1st degree burn": "images/first.png",
  incision: "images/incision.png",
  laceration: "images/laceration.png",
  "abdominal thrust": "images/not.png",
  "choking (unconscious)": "images/not.png",
  "open fracture": "images/open.png",
  "penetrating object": "images/penetrating.png",
  "chest thrust": "images/pregnant.png",
  "puncture wound": "images/puncture.png",
  "2nd degree burn": "images/second.png",
  shock: "images/shock.png",
  "snake bite": "images/snake.png",
  sprain: "images/sprain.png",
  strain: "images/strain.png",
  "3rd degree burn": "images/third.png",
  "scorpion sting": "images/scorpion.png",
  "jellyfish sting": "images/jellyfish.png",
  "animal bite": "images/animal.png",
  "electrical burn": "images/electrical.png",
  "epistaxis (nose bleed)": "images/nose.png",
};

// ðŸ”¹ NEW: Text descriptions for injuries without images
const injuryDescriptions = {
  concussion: "Lost consciousness for 10 seconds, mild headache",
  "compression": "Headache increasing as time pass, heavy breathing, face red",
  "spinal injury": "Deformity at the spine, unable to move lower limbs",
  "heat cramp": "Muscle cramps, body red, sweating a lot",
  "heat stroke": "Not sweating, skin extremely red, headache, dizziness",
  fits: "Shaking vigorously",
  fainting: "Unconscious",
  "hypoglycaemia/low blood sugar": "Weak and pale, cold sweats",
  "stroke": "Face drooping",
  asthma: "Difficulty breathing, wheezing sounds.",
  hyperventilation: "Rapid breathing, feeling dizzy or lightheaded.",
  "muscle cramp": "Sharp pain, muscle tense up",
};

// Reload page while keeping selections
reloadBtn.addEventListener("click", () => {
    localStorage.setItem("selectedScenario", scenarioSelect.value);
    localStorage.setItem("selectedCasualty", casualtySelect.value);
    location.reload();
});

// Firestore live listener
const q = query(collection(db, "scenarios"));
onSnapshot(q, snapshot => {
    allScenarios = [];
    snapshot.forEach(doc => allScenarios.push({ id: doc.id, ...doc.data() }));

    const scenarioNumbers = [...new Set(allScenarios.map(s => s.scenarioNumber))];
    scenarioSelect.innerHTML = '<option value="">-- Select Scenario --</option>';
    scenarioNumbers.forEach(num => {
        const option = document.createElement("option");
        option.value = num;
        option.textContent = num;
        scenarioSelect.appendChild(option);
    });

    const savedScenario = localStorage.getItem("selectedScenario");
    const savedCasualty = localStorage.getItem("selectedCasualty");

    if (savedScenario) {
        scenarioSelect.value = savedScenario;
        updateCasualtyDropdown(savedScenario, savedCasualty);
    }
    if (savedScenario && savedCasualty) {
        displaySelectedCasualty(savedCasualty, savedScenario);
    }
});

function updateCasualtyDropdown(selectedScenario, selectedCasualty = null) {
    const casualties = allScenarios
        .filter(s => s.scenarioNumber === selectedScenario)
        .map(s => s.casualtyNumber);

    const uniqueCasualties = [...new Set(casualties)];

    casualtySelect.innerHTML = '<option value="">-- Select Casualty --</option>';
    uniqueCasualties.forEach(num => {
        const option = document.createElement("option");
        option.value = num;
        option.textContent = "Casualty " + num;
        casualtySelect.appendChild(option);
    });

    if (selectedCasualty && uniqueCasualties.includes(selectedCasualty)) {
        casualtySelect.value = selectedCasualty;
    }

    clearDisplay();
}

scenarioSelect.addEventListener('change', () => {
    localStorage.setItem("selectedScenario", scenarioSelect.value);
    updateCasualtyDropdown(scenarioSelect.value);
});

casualtySelect.addEventListener('change', () => {
    localStorage.setItem("selectedCasualty", casualtySelect.value);
    displaySelectedCasualty(casualtySelect.value, scenarioSelect.value);
});

function displaySelectedCasualty(selectedCasualty, selectedScenario) {
    const match = allScenarios.find(s =>
        s.scenarioNumber === selectedScenario &&
        s.casualtyNumber === selectedCasualty
    );

    if (!match) return;

    displayScenario.textContent = match.scenarioNumber;
    displayCasualty.textContent = 
    match.visibility?.casualtyName ? match.casualtyName : "";

    displayInjuries.innerHTML = "";

if (match.visibility?.injuries && match.injuries) {

    match.injuries.forEach(injuryObj => {

        const div = document.createElement("div");
        div.style.marginBottom = "10px";

        const side = injuryObj.side === "NA" ? "" : injuryObj.side;
        const site = injuryObj.site === "NA" ? "" : injuryObj.site;
        
        const locationText = `${side} ${site}`.trim();

        div.innerHTML = locationText
            ? `<strong>${locationText}</strong><br>`
            : `<br>`;

        const lower = injuryObj.type.toLowerCase();
        let matchedKey = Object.keys(injuryImages)
            .find(key => lower.includes(key));

        if (matchedKey) {
            const img = document.createElement("img");
            img.src = injuryImages[matchedKey];
            img.style.width = "150px";
            img.onerror = () => showTextDescription(div, injuryObj.type, lower);
            div.appendChild(img);
        } else {
            showTextDescription(div, injuryObj.type, lower);
        }

        displayInjuries.appendChild(div);
    });
}

    displayWhatHappened.textContent = match.visibility?.whatHappened ? match.whatHappened : "";
    displayMedicalHistory.textContent = match.visibility?.medicalHistory ? match.medicalHistory : "";
    displayAllergies.textContent = match.visibility?.allergies ? match.allergies : "";
    displayLastMeal.textContent = match.visibility?.lastMeal ? match.lastMeal : "";
}

// Helper function to show text description when no image
function showTextDescription(container, injury, lower) {
    const textDiv = document.createElement("div");
    textDiv.style.padding = "10px";
    textDiv.style.backgroundColor = "#f8f8f8";
    textDiv.style.border = "1px solid #ccc";
    textDiv.style.marginTop = "5px";

    textDiv.innerHTML = `<strong>${injury}</strong><br>${injuryDescriptions[lower] || "Visible injury observed."}`;
    container.appendChild(textDiv);
}

function clearDisplay() {
    displayScenario.textContent = '';
    displayCasualty.textContent = '';
    displayInjuries.innerHTML = '';
    displayWhatHappened.textContent = '';
    displayMedicalHistory.textContent = '';
    displayAllergies.textContent = '';
    displayLastMeal.textContent = '';
}
</script>

</body>
</html>